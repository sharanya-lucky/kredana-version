import React, { useEffect, useState } from "react";
import {
  doc,
  setDoc,
  getDoc,
  serverTimestamp,
} from "firebase/firestore";
import { db } from "../../../../firebase";
import { useAuth } from "../../../../context/AuthContext";

const AchievementsTrack = ({ setStep }) => {
  const { user } = useAuth();

  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);

  const [formData, setFormData] = useState({
    achievements: {
      district: { gold: "", silver: "", bronze: "" },
      state: { gold: "", silver: "", bronze: "" },
      national: { gold: "", silver: "", bronze: "" },
    },
    awardsImages: [],
    mediaMentions: [],
  });

  const [errors, setErrors] = useState({});

  // ================= LOAD DATA =================
  useEffect(() => {
    const fetchData = async () => {
      if (!user?.uid) {
        setLoading(false);
        return;
      }

      try {
        const docRef = doc(db, "myactivity", user.uid);
        const docSnap = await getDoc(docRef);

if (docSnap.exists()) {
  const data = docSnap.data();

  setFormData({
    achievements: {
      district: {
        gold: data?.achievements?.district?.gold ?? "",
        silver: data?.achievements?.district?.silver ?? "",
        bronze: data?.achievements?.district?.bronze ?? "",
      },
      state: {
        gold: data?.achievements?.state?.gold ?? "",
        silver: data?.achievements?.state?.silver ?? "",
        bronze: data?.achievements?.state?.bronze ?? "",
      },
      national: {
        gold: data?.achievements?.national?.gold ?? "",
        silver: data?.achievements?.national?.silver ?? "",
        bronze: data?.achievements?.national?.bronze ?? "",
      },
    },
    awardsImages: data?.awardsImages ?? [],
    mediaMentions: data?.mediaMentions ?? [],
  });
}
      } catch (error) {
        console.error("Error loading:", error);
      }

      setLoading(false);
    };

    fetchData();
  }, [user]);

  // ================= HANDLE INPUT =================
  const handleChange = (category, medal, value) => {
    if (Number(value) < 0) return;

    setFormData((prev) => ({
      ...prev,
      achievements: {
        ...prev.achievements,
        [category]: {
          ...prev.achievements[category],
          [medal]: value,
        },
      },
    }));

    setErrors((prev) => ({
      ...prev,
      [`${category}-${medal}`]: "",
    }));
  };

  // ================= VALIDATION =================
  const validate = () => {
    let newErrors = {};

    ["district", "state", "national"].forEach((level) => {
      ["gold", "silver", "bronze"].forEach((medal) => {
        const value = formData.achievements[level][medal];

        if (value === "") {
          newErrors[`${level}-${medal}`] = "Required";
        } else if (Number(value) < 0) {
          newErrors[`${level}-${medal}`] = "Cannot be negative";
        }
      });
    });

    if (formData.awardsImages.length === 0) {
      newErrors.awardsImages = "Upload at least one award image";
    }

    if (formData.mediaMentions.length === 0) {
      newErrors.mediaMentions = "Upload at least one media image";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  // ================= CLOUDINARY UPLOAD =================
// ================= CLOUDINARY UPLOAD (SAME AS MEDIA PAGE) =================
const uploadToCloudinary = async (file) => {
  const fd = new FormData();
  fd.append("file", file);
  fd.append("upload_preset", "kridana_upload"); // SAME PRESET

  try {
    const res = await fetch(
      "https://api.cloudinary.com/v1_1/daiyvial8/image/upload",
      {
        method: "POST",
        body: fd,
      }
    );

    if (!res.ok) {
      const errorData = await res.json();
      console.error("Cloudinary Error Response:", errorData);
      throw new Error("Upload failed");
    }

    const data = await res.json();
    return data.secure_url;
  } catch (err) {
    console.error("Cloudinary Upload Error:", err);
    alert("Image upload failed");
    return null;
  }
};

  // ================= FILE UPLOAD (MAX 3) =================
const handleUpload = async (e, type) => {
  const files = Array.from(e.target.files);
  if (!files.length) return;

  if (formData[type].length + files.length > 3) {
    alert("Maximum 3 images allowed.");
    return;
  }

  try {
    const uploadedUrls = [];

    for (let file of files) {
      const url = await uploadToCloudinary(file);
      if (url) uploadedUrls.push(url);
    }

    if (uploadedUrls.length === 0) {
      alert("Upload failed");
      return;
    }

    setFormData((prev) => ({
      ...prev,
      [type]: [...prev[type], ...uploadedUrls],
    }));

    e.target.value = "";
  } catch (error) {
    console.error("Upload Error:", error);
    alert("Upload failed");
  }
};
  // ================= REMOVE IMAGE =================
  const removeImage = (type, index) => {
    const updated = [...formData[type]];
    updated.splice(index, 1);

    setFormData((prev) => ({
      ...prev,
      [type]: updated,
    }));
  };

  // ================= SAVE =================
  const handleSave = async () => {
    if (!user?.uid) {
      alert("User not logged in");
      return;
    }

    const isValid = validate();
    if (!isValid) {
      alert("Please fill all required details.");
      return;
    }

    try {
      setSaving(true);

      await setDoc(
        doc(db, "myactivity", user.uid),
        {
          ...formData,
          updatedAt: serverTimestamp(),
        },
        { merge: true }
      );

      alert("Saved Successfully!");
    } catch (error) {
      console.error("Save Error:", error);
      alert("Error saving data");
    } finally {
      setSaving(false);
    }
  };

  // ================= CANCEL =================
  const handleCancel = () => {
    setFormData({
      achievements: {
        district: { gold: "", silver: "", bronze: "" },
        state: { gold: "", silver: "", bronze: "" },
        national: { gold: "", silver: "", bronze: "" },
      },
      awardsImages: [],
      mediaMentions: [],
    });

    setErrors({});
  };

  if (loading) return <p className="p-6 text-gray-500">Loading...</p>;

  return (
    <div className="w-full">
      <div
        onClick={() => setStep(2)}
        className="cursor-pointer text-orange-600 mb-4"
      >
        ← Back
      </div>

      <h2 className="text-orange-500 font-semibold text-xl mb-6">
        Achievements & Track Record
      </h2>

      {/* TABLE */}
      <div className="overflow-x-auto mb-8">
        <table className="min-w-full border border-gray-300">
          <thead>
            <tr className="bg-gray-100 text-orange-500">
              <th className="p-3 border">Category</th>
              <th className="p-3 border">Gold</th>
              <th className="p-3 border">Silver</th>
              <th className="p-3 border">Bronze</th>
            </tr>
          </thead>

          <tbody>
            {["district", "state", "national"].map((level) => (
              <tr key={level} className="text-center">
                <td className="p-3 border capitalize font-medium">
                  {level}
                </td>

                {["gold", "silver", "bronze"].map((medal) => (
                  <td key={medal} className="p-3 border">
                    <input
                      type="number"
                      min="0"
                      value={formData.achievements?.[level]?.[medal] ?? ""}
                      onChange={(e) =>
                        handleChange(level, medal, e.target.value)
                      }
                      className={`w-full border rounded px-2 py-1 ${
                        errors[`${level}-${medal}`]
                          ? "border-red-500"
                          : "border-gray-300"
                      }`}
                    />
                    {errors[`${level}-${medal}`] && (
                      <p className="text-red-500 text-xs">
                        {errors[`${level}-${medal}`]}
                      </p>
                    )}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* ================= AWARDS UPLOAD ================= */}
      {["awardsImages", "mediaMentions"].map((type) => (
        <div key={type} className="mb-8">
          <label className="font-medium block mb-2 capitalize">
            {type === "awardsImages"
              ? "Awards Images Upload"
              : "Media Mentions Upload"}
          </label>

          <div className="flex items-center border rounded px-4 py-2 min-h-14">
            <div className="flex gap-2 flex-wrap flex-1">
              {formData[type].map((img, index) => (
                <div key={index} className="relative">
                  <img
                    src={img}
                    alt="upload"
                    className="h-10 w-10 object-cover rounded"
                  />
                  <button
                    onClick={() => removeImage(type, index)}
                    className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center"
                  >
                    ×
                  </button>
                </div>
              ))}
            </div>

            {formData[type].length < 3 && (
              <label className="cursor-pointer">
                <img
                  src="/upload.png"
                  alt="upload"
                  className="w-6 h-6"
                />
                <input
                  type="file"
                  multiple
                  className="hidden"
                  onChange={(e) => handleUpload(e, type)}
                />
              </label>
            )}
          </div>

          {formData[type].length > 0 && (
            <p className="text-green-600 text-sm mt-2">
              {formData[type].length} image
              {formData[type].length > 1 ? "s" : ""} uploaded
            </p>
          )}

          {errors[type] && (
            <p className="text-red-500 text-sm mt-2">{errors[type]}</p>
          )}
        </div>
      ))}

      {/* ================= BUTTONS ================= */}
      <div className="flex justify-end gap-4">
        <button
          onClick={handleCancel}
          className="text-gray-600 hover:text-black"
        >
          Cancel
        </button>

        <button
          onClick={handleSave}
          disabled={saving}
          className="bg-orange-500 text-white px-6 py-2 rounded"
        >
          {saving ? "Saving..." : "Save Changes"}
        </button>
      </div>
    </div>
  );
};

export default AchievementsTrack;